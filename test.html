<html>

	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.16.2/lodash.js"></script>
		<script src="creature.js"></script>
		<script src="food.js"></script>
		<script src="neuron.js"></script>
		<script src="layer.js"></script>
		<script src="brain.js"></script>
	</head>

	<body>

		<div id="world">

		</div>
		<input type="number" id="speed" value="1" onchange="setSpeed()"/>
		<button onclick="upSpeed()">faster</button>
		<button onclick="downSpeed()">slower</button>
		<button onclick="init()">restart</button>
		<div id="list"></div>
	</body>
</html>
<script>
	'use strict';

	var min_creature_count = 20
	var creatures = []
	var foods = []
	var render = true;
    var pause = false
	var speed = 8;
	var ticks = 0;
	var world = {
		top : 50,
		bottom : 550,
		left : 50,
		right : 1050
	}

	var deaders = [];

	// var b = brain().init();


	// console.log(b.think([-0.5, -0.5]))
	// console.log('---')
	// console.log(b.think([-0.5, 0.5]))


	var createCreatures = function(){
		_.range(0, 20).forEach(function () {
			creatures.push(creature())
		})

		creatures.forEach(function (creature) {
			creature.init()
		})
	}

	var createFoods = function(){
		_.range(0, 30).forEach(function () {
			foods.push(food())
		})

		foods.forEach(function (food) {
			food.init()
		})
	}

	function upSpeed(){
		speed = speed*2
		$('#speed').val(speed)
	}

	function downSpeed(){
		if(speed > 1){
			speed = Math.round(speed/2)
		}
		$('#speed').val(speed)
	}

	function setSpeed(){
		console.log('setting speed')
		speed = +$('#speed').val()
	}

	var isInsideWorld = function (creature) {
	    return world.left <= creature.x && world.right >= creature.x && world.top <= creature.y && world.bottom >= creature.y;
	}

	var isCollidingWith = function (el1, el2) {
		var min = Math.pow(el1.radius - el2.radius, 2)
	 	var pos = Math.pow(el1.x - el2.x, 2) +  Math.pow(el1.y - el2.y, 2)
		var max = Math.pow(el1.radius + el2.radius, 2)

		return (min <= pos && pos <= max)
	}

	var displayTopBrain = function(){
		// console.log('--')
		// console.log(creatures[0].normalized_direction)
		// console.log(creatures[0].path_to_food)
	}

	var divideWeights = function (weights, chunk_count) {
		if(weights.length % chunk_count !== 0){
			console.log(weights)
			console.log(chunk_count)
			throw 'bad chunking mod'
		}
		return _.chunk(weights, weights.length / chunk_count)
	}



	var getNewGenome = function () {
		


			// if(percent)
		
		

		//var chosen = best[probsMath.random() * 100
	}

	var getWeightedRandom = function () {
		var level = Math.random() * 100;

		if(level < 40){
			return 0
		}
		if(level < 70){
			return 1
		}
		if(level < 90){
			return 2
		}
		return 3
	}


	function updateList(){
		var list = $('#list')

		list.empty()

		deaders = _.sortBy(deaders, 'lifetime').reverse()

		deaders.forEach( (c, index) =>{
			if(index > 10){
				return
			}
			list.append('<div style="background-color:'+c.color+'">'+c.id+' '+c.lifetime + '</div>')
		})
		//list.append('hello')
	}

	function tick(){
		ticks ++;

		if(speed === 0 || pause){
			setTimeout(function () {
				tick()
			}, 100)
			return
		}


		creatures.forEach(function (creature) {
			creature.think();
			creature.move();
		});

		if(ticks % 100 === 0){
			var new_food = food()
			new_food.init() 
			foods.push(new_food)
		}


		//console.log(ticks % speed)
		if(render && ticks % speed === 0){
			window.requestAnimationFrame(tick);
			displayTopBrain()
			updateList()
		}
		else {
			if(ticks % 500 === 0){
				setTimeout(function () {
					tick()
				})
			}
			else {
				tick()
			}
		}
	}

	$(document).keypress(function(e) {
	  if(e.which == 13) {
	    pause = !pause

	  }
	});

	setInterval(function () {
		ticks = 0
	}, 1000);

	function init(){
		$('#world').empty()
		creatures = []
		foods = []
		createCreatures()
		createFoods()
	}

	init()
	
	window.requestAnimationFrame(tick);

</script>
<style>
	body {
		
	}
	#world {
		background-color:lightblue;
		margin:50px;
		width:1000px;
		height:500px;
		background-size: 25px 25px;
	    background-image: linear-gradient(to right, grey 1px, transparent 1px), linear-gradient(to bottom, grey 1px, transparent 1px);
	}
	.creature {
		position:absolute;
		text-align:center;
		transform: translate3d(0, 0, 0);
		/*background-color:pink;*/
		border-radius: 99px;
		border-right:2px solid red;
		border-top: 0px solid purple;
		border-bottom: 0px solid purple;
	}
	.food {
		position:absolute;
		text-align:center;
		transform: translate3d(0, 0, 0);
		background-color:yellow;
		border : 1px solid orange;
		width:10px;
		height:10px;
		border-radius: 99px;
		left:5px;
		top:-5px;
	}
	.eye {
		position: absolute;
		width : 4px;
		height:  4px;
		background-color : black;
		border-radius: 99px;
		border-right:1px solid white;
	}

	.flagged {
		background-color: lightgrey;
	}
</style>